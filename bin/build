#!/usr/bin/env bash

set -e

cd /opt/build

# Check if the image contains the correct version of Elixir and Erlang
. $HOME/.asdf/asdf.sh
. $HOME/.asdf/completions/asdf.bash

# Install updated versions of hex/rebar
mix local.rebar --force
mix local.hex --if-missing --force

export MIX_ENV=prod

# Fetch deps and compile
# mix deps.clean
mix deps.get

# Run an explicit clean to remove any build artifacts from the host
mix do clean, compile --force
# Build the release
mix release

exit 0
